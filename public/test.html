<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Pay with Flow</title>
    <script src="https://checkout-web-components.checkout.com/index.js"></script>
    <style>
      body, body * {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Fira Sans', 'Droid Sans', 'Helvetica Neue', 'Noto Sans', 'Liberation Sans', Arial, sans-serif;
      }
      .payment-method-container {
        margin-bottom: 16px;
        padding: 16px;
        border-radius: 4px;
        border: 1px solid #DDDDDD;
        cursor: pointer;
      }
      .payment-method-container h2 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 20px;
      }
      .payment-method-container.selected {
        border-color: #186AFF;
      }
      .payment-method-container.selected h2 {
        color: #186AFF;
      }
      .payment-method-container:not(.selected) .payment-method {
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>Pay with Flow</h1>
    <div class="payments-container">
      <div id="card-container" class="payment-method-container selected">
        <h2>Card</h2>
        <div id="card" class="payment-method"></div>
      </div>
      <div id="ideal-container" class="payment-method-container">
        <h2>iDEAL</h2>
        <div id="ideal" class="payment-method"></div>
      </div>
    </div>
    <button id="pay-button" type="button">Pay €100.00</button>
    <script>
      (async () => {
        const amount = 10000;
        let selectedPaymentMethod = 'card';
        let amountOverride;

        const createPaymentSession = async () => {
          const response = await fetch(
            "https://api.sandbox.checkout.com/payment-sessions",
            {
              body: JSON.stringify({
                amount,
                currency: "EUR",
                billing: {
                  address: {
                    country: "NL",
                  },
                },
                success_url: "https://example.com/success",
                failure_url: "https://example.com/failure",
                processing_channel_id: "{PROCESSING_CHANNEL_ID}",
              }),
              headers: {
                "Content-Type": "application/json",
                Authorization: "{SECRET_KEY}",
              },
              method: "POST",
              mode: "cors",
            }
          );
          return response.json();
        };

        const performPaymentSubmission = async (submitData) => {
          const response = await fetch(
            `https://api.sandbox.checkout.com/payment-sessions/${paymentSession.id}/submit`,
            {
              body: JSON.stringify(submitData),
              headers: {
                "Content-Type": "application/json",
                Authorization: "{SECRET_KEY}",
              },
              method: "POST",
              mode: "cors",
            }
          );
          return response.json();
        };

        const cardContainer = document.getElementById("card-container");
        const idealContainer = document.getElementById("ideal-container");
        const payButton = document.getElementById("pay-button");

        const paymentSession = await createPaymentSession();

        const checkout = await CheckoutWebComponents({
          publicKey: "{PUBLIC_KEY}",
          paymentSession,
          onError: (_, error) => {
            console.warn(error);
          },
          onCardBinChanged: (_self, cardMetadata) => {
            if (cardMetadata?.scheme === "american_express" || cardMetadata?.card_category === 'commercial') {
              amountOverride = amount * 1.02;
              payButton.textContent = `Pay €${(amountOverride / 100).toFixed(2)}`;
            } else {
              amountOverride = undefined;
              payButton.textContent = `Pay €${(amount / 100).toFixed(2)}`;
            }
          },
          onPaymentCompleted: (_self) => {
            window.location.href = 'https://example.com/success';
          },
          handleSubmit: async (_self, { session_data }) => {
            return performPaymentSubmission({
              amount: amountOverride,
              session_data,
            });
          },
          showPayButton: false,
          environment: "sandbox",
        });

        const cardComponent = checkout.create("card", {
          acceptedCardSchemes: ["visa", "mastercard", "american_express"],
        });
        if (await cardComponent.isAvailable()) {
          cardComponent.mount("#card");
        }

        const idealComponent = checkout.create("ideal");
        if (await idealComponent.isAvailable()) {
          idealComponent.mount("#ideal");
        }

        cardContainer.addEventListener('click', () => {
          selectedPaymentMethod = 'card';
          cardContainer.classList.add('selected');
          idealContainer.classList.remove('selected');
        });
        idealContainer.addEventListener('click', () => {
          selectedPaymentMethod = 'ideal';
          idealContainer.classList.add('selected');
          cardContainer.classList.remove('selected');
        });

        payButton.addEventListener("click", async () => {
          if (selectedPaymentMethod === "card") {
            cardComponent.submit();
          } else if (selectedPaymentMethod === "ideal") {
            idealComponent.submit();
          }
        });
      })();
    </script>
  </body>
</html>